# M2 Format ðŸŽ­

M2 (Model 2) is the primary model format for characters, creatures, and doodads
in World of Warcraft.

## Overview

- **Extension**: `.m2` (formerly `.mdx`)
- **Purpose**: Animated 3D models with bones, textures, and effects
- **Components**: Geometry, animations, bones, textures, particles
- **Related Files**:
  - `.skin` - Level of detail and mesh data
  - `.anim` - External animation sequences
  - `.phys` - Physics simulation data

## Structure

### M2 Header

```rust
struct M2Header {
    magic: [u8; 4],              // "MD20"
    version: u32,                // Model version
    name_length: u32,            // Length of model name
    name_offset: u32,            // Offset to model name
    global_flags: u32,           // Model-wide flags
    global_sequences: M2Array<u32>, // Global animation sequences
    animations: M2Array<M2Animation>,
    animation_lookups: M2Array<i16>,
    bones: M2Array<M2Bone>,
    key_bone_lookups: M2Array<i16>,
    vertices: M2Array<M2Vertex>,
    num_skin_profiles: u32,      // Number of .skin files
    colors: M2Array<M2Color>,
    textures: M2Array<M2Texture>,
    texture_weights: M2Array<M2TextureWeight>,
    texture_transforms: M2Array<M2TextureTransform>,
    replaceable_texture_lookups: M2Array<i16>,
    materials: M2Array<M2Material>,
    bone_combos: M2Array<i16>,
    texture_combos: M2Array<i16>,
    texture_coord_combos: M2Array<i16>,
    bounding_box: BoundingBox,
    bounding_sphere_radius: f32,
    collision_box: BoundingBox,
    collision_sphere_radius: f32,
    // ... many more fields
}

struct M2Array<T> {
    count: u32,
    offset: u32,
    _phantom: PhantomData<T>,
}
```

### Vertex Data

```rust
struct M2Vertex {
    position: Vec3,
    bone_weights: [u8; 4],
    bone_indices: [u8; 4],
    normal: Vec3,
    texture_coords: [Vec2; 2],
}
```

### Animation Data

```rust
struct M2Animation {
    id: u16,                    // Animation ID (0=Stand, 1=Walk, etc.)
    sub_id: u16,                // Variation number
    length: u32,                // Duration in milliseconds
    move_speed: f32,            // Movement speed
    flags: u32,                 // Loop, low priority, etc.
    probability: i16,           // Chance to play
    unused: i16,
    repeat_min: u32,
    repeat_max: u32,
    blend_time: u32,
    bounds: BoundingBox,
    radius: f32,
    next_animation: i16,        // Animation to play next
    alias_next: i16,            // Alias animation
}
```

## Usage Example

```rust
use warcraft_rs::m2::{M2Model, AnimationId};

// Load M2 model
let mut model = M2Model::open("Creature/Murloc/Murloc.m2")?;

// Load associated skin file
model.load_skin(0)?; // LOD 0 (highest detail)

// Get model information
println!("Model: {}", model.name());
println!("Vertices: {}", model.vertex_count());
println!("Animations: {}", model.animation_count());
println!("Bones: {}", model.bone_count());

// List animations
for anim in model.animations() {
    println!("Animation {}: {} ms", anim.id, anim.length);
}

// Animate model
let time_ms = 1500;
let anim_id = AnimationId::Walk;
model.animate(anim_id, time_ms);

// Get animated vertex positions
let vertices = model.get_animated_vertices();

// Extract textures
for (i, texture) in model.textures().enumerate() {
    println!("Texture {}: {}", i, texture.filename);
}

// Render model
let mesh = model.build_mesh()?;
renderer.draw_mesh(&mesh);
```

## Animation System

### Animation IDs

Common animation IDs:

```rust
enum AnimationId {
    Stand = 0,
    Death = 1,
    Spell = 2,
    Stop = 3,
    Walk = 4,
    Run = 5,
    Dead = 6,
    Rise = 7,
    StandWound = 8,
    CombatWound = 9,
    CombatCritical = 10,
    ShuffleLeft = 11,
    ShuffleRight = 12,
    Walkbackwards = 13,
    // ... many more
}
```

### Animation Playback

```rust
struct AnimationPlayer {
    model: M2Model,
    current_anim: u16,
    current_time: u32,
    loop_count: u32,
}

impl AnimationPlayer {
    fn update(&mut self, delta_ms: u32) {
        self.current_time += delta_ms;

        let anim = self.model.get_animation(self.current_anim);
        if self.current_time >= anim.length {
            if anim.is_looping() {
                self.current_time %= anim.length;
                self.loop_count += 1;
            } else {
                // Play next animation
                self.play_animation(anim.next_animation);
            }
        }

        // Update bone transforms
        self.model.update_bones(self.current_anim, self.current_time);
    }
}
```

## Advanced Features

### Bone Manipulation

```rust
// Get bone by name
let head_bone = model.find_bone("Head")?;

// Apply custom rotation
model.set_bone_rotation(head_bone, Quaternion::from_euler(0.0, 45.0, 0.0));

// Attach item to bone
let weapon_bone = model.find_bone("HandRight")?;
let transform = model.get_bone_transform(weapon_bone);
weapon_model.set_transform(transform);
```

### Particle Effects

```rust
for emitter in model.particle_emitters() {
    if emitter.is_enabled() {
        let particles = emitter.update(delta_time);

        for particle in particles {
            renderer.draw_particle(
                particle.position,
                particle.color,
                particle.size,
                emitter.texture
            );
        }
    }
}
```

### Character Customization

```rust
// Change skin color
model.set_skin_color(CharacterRace::Human, SkinTone::Dark);

// Set hair style
model.set_geoset(GeosetType::Hair, hair_style_id);

// Apply armor
model.hide_geosets(&[GeosetType::Boots, GeosetType::Pants]);
model.show_geosets(&[GeosetType::Robe]);
```

## Common Patterns

### Model Instancing

```rust
struct ModelInstance {
    model: Arc<M2Model>,
    transform: Matrix4,
    animation_state: AnimationState,
    tint_color: Color,
}

struct ModelRenderer {
    instances: HashMap<u32, Vec<ModelInstance>>,
}

impl ModelRenderer {
    fn render_all(&self) {
        for (model_id, instances) in &self.instances {
            // Bind model data once
            self.bind_model_data(model_id);

            // Render all instances
            for instance in instances {
                self.set_instance_data(&instance);
                self.draw_instance();
            }
        }
    }
}
```

### LOD Management

```rust
fn select_lod(model: &M2Model, distance: f32) -> u32 {
    if distance < 20.0 {
        0  // Highest detail
    } else if distance < 50.0 {
        1  // Medium detail
    } else if distance < 100.0 {
        2  // Low detail
    } else {
        3  // Lowest detail
    }
}
```

## Performance Considerations

- Use instancing for repeated models
- Load appropriate LOD based on distance
- Cache animation bone transforms
- Batch render calls by texture
- Use view frustum culling

## Common Issues

### Missing Textures

- Check texture type flags
- Some textures are hardcoded
- Character textures may be composited

### Animation Blending

- Not all animations blend smoothly
- Check blend_time values
- Some animations are meant to be instant

### Bone Attachment

- Attachment points have specific IDs
- Not all models have all attachments
- Check attachment lookup table

## References

- [M2 Format (wowdev.wiki)](https://wowdev.wiki/M2)
- [M2 Animation Lists](https://wowdev.wiki/M2#Animation_sequences)
- [Character Customization](https://wowdev.wiki/Character_customization)

## See Also

- [M2 Skin Format](m2-skin.md) - Mesh and LOD data
- [M2 Anim Format](m2-anim.md) - External animations
- [BLP Format](blp.md) - Texture format
- [Model Rendering Guide](../../guides/model-rendering.md)
